<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrector de Pronunciación</title>
</head>
<body>
    <h1>Ejercicio de Pronunciación</h1>
    <p>Di la siguiente frase: "I am learning English"</p>

    <button id="recordButton">Grabar</button>
    <button id="stopButton" disabled>Detener</button>

    <div id="feedback"></div>

    <script>
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const feedbackDiv = document.getElementById('feedback');
        const webhookUrl = 'https://hook.us2.make.com/8jihc55lka1pres36v9iip8fe7485nmp'; // <-- CORREGIDO: la URL ahora tiene comillas

        let mediaRecorder;
        let audioChunks = [];

        recordButton.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            
            audioChunks = [];
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            recordButton.disabled = true;
            stopButton.disabled = false;
            feedbackDiv.innerHTML = 'Enviando audio para corrección...';
        };

        stopButton.onclick = () => {
            mediaRecorder.stop();
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendToMake(audioBlob);
            };
            recordButton.disabled = false;
            stopButton.disabled = true;
        };

        async function sendToMake(audioBlob) {
            feedbackDiv.innerHTML = 'Recibiendo corrección...';
            const formData = new FormData();
            formData.append('audio', audioBlob, 'pronunciation.webm');

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                if (result.status === 'correcto') {
                    feedbackDiv.innerHTML = `<h3>¡Excelente! Tu pronunciación es perfecta.</h3>`;
                } else {
                    feedbackDiv.innerHTML = `<h3>${result.message}</h3>`;
                }
                
                const audioPlayer = document.createElement('audio');
                audioPlayer.controls = true;
                audioPlayer.src = result.audio_url;
                feedbackDiv.appendChild(audioPlayer);

            } catch (error) {
                feedbackDiv.innerHTML = 'Hubo un error al obtener la corrección. Intenta de nuevo.';
                console.error(error);
            }
        }
    </script>
</body>
</html>
